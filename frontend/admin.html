<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- ... 기존 head 내용 ... -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- 관리자 정보 및 대시보드 통계 -->
    <div class="header" style="background: #f7fafc; padding: 20px 0 10px 0; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px;">
        <div class="header-content" style="display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: 0 auto;">
            <div style="font-size: 1.2em; font-weight: 600; color: #2d3748;">
                🏥 <span>관리자 ID: <span id="admin-id">-</span></span>
                <span style="margin-left: 20px;">이름: <span id="admin-name">-</span></span>
            </div>
            <button onclick="logout()" class="button button-secondary" style="height: 40px;">🚪 로그아웃</button>
        </div>
    </div>
    <div class="container" style="max-width: 1200px; margin: 0 auto;">
        <!-- 대시보드 통계 카드 -->
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 18px; margin-bottom: 30px;">
            <div class="stat-card" style="background: white; padding: 18px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); text-align: center;">
                <div class="stat-number" id="total-users">-</div>
                <div class="stat-label">총 사용자</div>
            </div>
            <div class="stat-card" style="background: white; padding: 18px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); text-align: center;">
                <div class="stat-number" id="total-sessions">-</div>
                <div class="stat-label">총 세션</div>
            </div>
            <div class="stat-card" style="background: white; padding: 18px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); text-align: center;">
                <div class="stat-number" id="month-sessions">-</div>
                <div class="stat-label">이번달 세션</div>
            </div>
            <div class="stat-card" style="background: white; padding: 18px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); text-align: center;">
                <div class="stat-number" id="pending-sessions">-</div>
                <div class="stat-label">대기중 세션</div>
            </div>
        </div>
        <!-- 관리자 세션 생성 폼(숨김 처리) -->
        <form id="admin-create-session-form" style="margin-bottom: 24px; display: none; gap: 10px; align-items: center;">
            <input id="admin-patient-name" type="text" placeholder="환자 이름" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;">
            <select id="admin-doctor-select" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; min-width: 180px;">
                <option value="">담당 의사를 선택하세요</option>
            </select>
            <button type="submit" class="button button-primary">세션 생성</button>
        </form>
        <!-- 전체 이용자(의사) 카드 리스트 -->
        <div id="user-list" style="display: none;"></div>
        <!-- 전체 이용자(의사) 테이블 리스트 -->
        <div style="margin-bottom:30px;">
          <table id="user-table" style="width:100%;border-collapse:collapse;background:#f7fafc;box-shadow:0 2px 8px rgba(0,0,0,0.04);border-radius:10px;overflow:hidden;">
            <thead style="background:#e2e8f0;">
              <tr>
                <th style="padding:10px;">이름</th>
                <th style="padding:10px;">아이디</th>
                <th style="padding:10px;">이메일</th>
                <th style="padding:10px;">권한</th>
                <th style="padding:10px;">상태</th>
                <th style="padding:10px;">통계</th>
                <th style="padding:10px;">승인/블락</th>
              </tr>
            </thead>
            <tbody id="user-table-body"></tbody>
          </table>
        </div>
        <!-- 이용자별 통계 영역 -->
        <div id="user-detail-stats"></div>
        <!-- 월별 차트(전체) -->
        <div style="background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 18px; margin-bottom: 24px;">
            <canvas id="monthlyChart" height="300"></canvas>
        </div>
        <!-- 통계 부가 정보 -->
        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;">
            <div id="active-users-info" style="font-size: 1.05em; color: #2b6cb0; min-width: 180px;"></div>
            <div id="completion-rate" style="font-size: 1.05em; color: #38a169; min-width: 180px;"></div>
            <div id="month-completed" style="font-size: 1.05em; color: #4299e1; min-width: 180px;"></div>
            <div id="expired-sessions-info" style="font-size: 1.05em; color: #e53e3e; min-width: 180px;"></div>
        </div>
        <!-- 시스템 로그 탭 -->
        <div id="logs-tab" class="tab-content">
            <h2>📋 시스템 로그</h2>
            
            <div class="search-controls">
                <select id="log-level-filter" class="search-input" style="flex: 0 0 150px;">
                    <option value="">모든 레벨</option>
                    <option value="info">정보</option>
                    <option value="warning">경고</option>
                    <option value="error">오류</option>
                </select>
                <button onclick="refreshLogs()" class="button button-secondary">🔄 새로고침</button>
            </div>
            
            <div id="logs-loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>로그를 불러오는 중...</p>
            </div>
            
            <div id="logs-container"></div>
            
            <div class="pagination" id="logs-pagination" style="display: none;">
                <button onclick="goToLogsPage(1)" id="logs-first-page"><<</button>
                <button onclick="goToLogsPage(currentLogsPage - 1)" id="logs-prev-page"><</button>
                <div id="logs-page-numbers"></div>
                <button onclick="goToLogsPage(currentLogsPage + 1)" id="logs-next-page">></button>
                <button onclick="goToLogsPage(totalLogsPages)" id="logs-last-page">>></button>
            </div>
        </div>
        
        <!-- 시스템 관리 탭 -->
        <div id="maintenance-tab" class="tab-content">
            <h2>🔧 시스템 관리</h2>
            
            <div style="display: grid; gap: 20px;">
                <div style="background: #f7fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #4299e1;">
                    <h3>🗑️ 데이터베이스 정리</h3>
                    <p>만료된 오래된 세션과 관련 데이터를 정리합니다.</p>
                    <div style="margin: 15px 0;">
                        <label for="cleanup-days">정리 기준 (일):</label>
                        <input type="number" id="cleanup-days" value="30" min="7" max="365" style="margin-left: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="simulateCleanup()" class="button button-secondary">🧪 시뮬레이션</button>
                        <button onclick="executeCleanup()" class="button button-danger">🗑️ 실행</button>
                    </div>
                    <div id="cleanup-result" style="margin-top: 15px;"></div>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffd700;">
                    <h3>⚠️ 시스템 상태</h3>
                    <div id="system-status">
                        <p>✅ 데이터베이스: 연결됨</p>
                        <p>✅ OpenAI API: 정상</p>
                        <p>✅ 메모리 사용량: 정상</p>
                    </div>
                    <button onclick="checkSystemHealth()" class="button button-secondary" style="margin-top: 10px;">🔍 상태 확인</button>
                </div>
            </div>
        </div>
        <!-- GPT 사용량 통계 -->
        <div class="card">
            <h2>🤖 GPT 사용량 통계</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-tokens">0</div>
                    <div class="stat-label">총 토큰</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-cost">$0.00</div>
                    <div class="stat-label">총 비용</div>
                </div>
            </div>
            
            <!-- 날짜 필터 -->
            <div class="filter-controls" style="margin: 20px 0;">
                <input type="date" id="gpt-start-date" class="form-input">
                <input type="date" id="gpt-end-date" class="form-input">
                <button onclick="loadGPTUsage()" class="button">조회</button>
            </div>
            
            <!-- 의사별 사용량 -->
            <h3>의사별 사용량</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>의사 ID</th>
                        <th>사용 횟수</th>
                        <th>총 토큰</th>
                        <th>총 비용</th>
                    </tr>
                </thead>
                <tbody id="gpt-doctor-stats">
                </tbody>
            </table>
            
            <!-- 모델별 사용량 -->
            <h3>모델별 사용량</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>모델</th>
                        <th>사용 횟수</th>
                        <th>총 토큰</th>
                        <th>총 비용</th>
                    </tr>
                </thead>
                <tbody id="gpt-model-stats">
                </tbody>
            </table>
        </div>
        <!-- 보안 모니터링 섹션 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">🔒 보안 모니터링</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="securityTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="login-attempts-tab" data-bs-toggle="tab" href="#login-attempts" role="tab">
                            로그인 시도 기록
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="ip-blocks-tab" data-bs-toggle="tab" href="#ip-blocks" role="tab">
                            IP 차단 목록
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="securityTabContent">
                    <!-- 로그인 시도 기록 -->
                    <div class="tab-pane fade show active" id="login-attempts" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>시간</th>
                                        <th>IP 주소</th>
                                        <th>의사 ID</th>
                                        <th>상태</th>
                                        <th>User Agent</th>
                                    </tr>
                                </thead>
                                <tbody id="loginAttemptsTable">
                                    <!-- 로그인 시도 기록이 여기에 동적으로 추가됩니다 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- IP 차단 목록 -->
                    <div class="tab-pane fade" id="ip-blocks" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>IP 주소</th>
                                        <th>시도 횟수</th>
                                        <th>마지막 시도</th>
                                        <th>차단 해제 시간</th>
                                    </tr>
                                </thead>
                                <tbody id="ipBlocksTable">
                                    <!-- IP 차단 목록이 여기에 동적으로 추가됩니다 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 시스템 설정 섹션 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">⚙️ 시스템 설정</h5>
            </div>
            <div class="card-body">
                <form id="systemSettingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maxConcurrentSessions" class="form-label">최대 동시 세션 수</label>
                                <input type="number" class="form-control" id="maxConcurrentSessions" min="1" max="5">
                                <div class="form-text">사용자당 허용되는 최대 동시 세션 수 (1-5)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sessionTimeout" class="form-label">세션 타임아웃 (분)</label>
                                <input type="number" class="form-control" id="sessionTimeout" min="5" max="120">
                                <div class="form-text">세션 자동 종료 시간 (5-120분)</div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">설정 저장</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // === API 서버 주소를 여기에 설정하세요 ===
        const API_BASE = "https://sct-backend-7epf.onrender.com";
        // ======================================
        let adminId = '';
        let adminName = '';
        let currentUsersPage = 1;
        let totalUsersPages = 1;
        let currentLogsPage = 1;
        let totalLogsPages = 1;
        let monthlyChart = null;
        let usageChart = null;
        let currentAdminSessionLink = '';
        
        // 🆕 의사 목록 로딩 함수 (이 전체 함수를 추가)
        async function loadDoctorsList() {
            try {
                console.log('의사 목록 로딩 시작');
                
                const response = await fetch(`${API_BASE}/admin/users?limit=100`, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('의사 목록 로드 실패');
                }
                
                const data = await response.json();
                console.log('의사 목록 로드 성공:', data);
                
                const doctorSelect = document.getElementById('admin-doctor-select');
                if (!doctorSelect) {
                    console.error('admin-doctor-select 요소를 찾을 수 없음');
                    return;
                }
                
                doctorSelect.innerHTML = '<option value="">담당 의사를 선택하세요</option>';
                
                // 인증된 의사들만 필터링
                const verifiedDoctors = data.users.filter(user => user.is_verified);
                
                verifiedDoctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.doctor_id;
                    option.textContent = `${doctor.name} (${doctor.doctor_id}) - ${doctor.specialty}`;
                    doctorSelect.appendChild(option);
                });
                
                console.log(`✅ ${verifiedDoctors.length}명의 인증된 의사 로드 완료`);
                
            } catch (error) {
                console.error('의사 목록 로드 오류:', error);
                alert('의사 목록을 불러오는데 실패했습니다. 페이지를 새로고침해주세요.');
            }
        }
        
        // 🆕 관리자용 세션 생성 함수 (이 전체 함수를 추가)
        async function handleAdminSessionCreate(event) {
            event.preventDefault();
            
            const patientName = document.getElementById('admin-patient-name').value.trim();
            const selectedDoctorId = document.getElementById('admin-doctor-select').value;
            
            console.log('관리자 세션 생성 시도:', { patientName, selectedDoctorId });
            
            if (!patientName) {
                alert('환자 이름을 입력해주세요.');
                return;
            }
            
            if (!selectedDoctorId) {
                alert('담당 의사를 선택해주세요.');
                return;
            }
            
            try {
                const requestBody = {
                    patient_name: patientName,
                    assigned_by: selectedDoctorId
                };
                
                console.log('전송할 데이터:', requestBody);
                
                const response = await fetch(`${API_BASE}/sct/sessions`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify(requestBody)
                });
                
                console.log('세션 생성 응답 상태:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('로그인이 만료되었습니다. 다시 로그인해주세요.');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }
                    const errorData = await response.json();
                    console.error('세션 생성 오류:', errorData);
                    throw new Error(errorData.detail || '세션 생성에 실패했습니다.');
                }
                
                const sessionData = await response.json();
                console.log('생성된 세션:', sessionData);
                
                // 성공 메시지 및 링크 표시
                const patientLink = `${window.location.origin}/patient.html?session=${sessionData.session_id}`;
                currentAdminSessionLink = patientLink;
                
                document.getElementById('admin-patient-link').textContent = patientLink;
                document.getElementById('admin-session-alert').style.display = 'block';
                
                // 폼 초기화
                document.getElementById('admin-patient-name').value = '';
                document.getElementById('admin-doctor-select').value = '';
                
                // 대시보드 통계 새로고침
                loadDashboardStats();
                
                console.log('✅ 관리자 세션 생성 완료');
                
            } catch (error) {
                console.error('관리자 세션 생성 오류:', error);
                alert('세션 생성 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 🆕 관리자용 링크 복사 함수 (이 전체 함수를 추가)
        function copyAdminLink() {
            if (!currentAdminSessionLink) {
                alert('복사할 링크가 없습니다.');
                return;
            }
            
            navigator.clipboard.writeText(currentAdminSessionLink).then(() => {
                alert('검사 링크가 클립보드에 복사되었습니다!');
            }).catch(err => {
                console.error('링크 복사 실패:', err);
                alert('링크 복사에 실패했습니다. 링크를 직접 복사해주세요.');
            });
        }
        // API 헤더
        function getApiHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }
        
        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            // 로그인 확인
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                window.location.href = 'login.html';
                return;
            }
            
            const userData = JSON.parse(currentUser);
            adminId = userData.doctorId;
            adminName = userData.name;
            
            // 관리자 권한 확인 (임시)
            if (!['admin', 'doctor1'].includes(adminId)) {
                alert('관리자 권한이 필요합니다.');
                window.location.href = 'doctor.html';
                return;
            }
            
            document.getElementById('admin-id').textContent = adminId;
            document.getElementById('admin-name').textContent = adminName;
            
            // 초기 데이터 로드
            loadDashboardStats();
            loadMonthlyChart();
            loadDoctorsList();
            
            // 🆕 관리자 세션 생성 폼 이벤트 연결
            const adminForm = document.getElementById('admin-create-session-form');
            if (adminForm) {
                adminForm.addEventListener('submit', handleAdminSessionCreate);
                console.log('✅ 관리자 세션 생성 폼 이벤트 연결됨');
            } else {
                console.error('❌ admin-create-session-form 요소를 찾을 수 없음');
            }
            // 검색 이벤트 설정
            if (document.getElementById('user-search')) {
                document.getElementById('user-search').addEventListener('input', debounce(searchUsers, 500));
            }
            document.getElementById('log-level-filter').addEventListener('change', refreshLogs);
            
            // 오늘 날짜를 기본값으로 설정
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('gpt-start-date').value = today;
            document.getElementById('gpt-end-date').value = today;
            
            // GPT 사용량 로드
            loadGPTUsage();
            loadSecurityData();
            
            // 1분마다 보안 데이터 갱신
            setInterval(loadSecurityData, 60000);
            
            // 시스템 설정 로드
            loadSystemSettings();
        });
        
        // 디바운스 함수
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // 로그아웃
        function logout() {
            if (confirm('정말 로그아웃 하시겠습니까?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('access_token');
                window.location.href = 'login.html';
            }
        }
        
        // 탭 전환
        function switchTab(tabName) {
            // 모든 탭 비활성화
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 선택된 탭 활성화
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // 탭별 데이터 로드
            switch(tabName) {
                case 'users':
                    loadUsers();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'logs':
                    loadLogs();
                    break;
                case 'maintenance':
                    checkSystemHealth();
                    break;
            }
        }
        
        // 대시보드 통계 로드
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/dashboard/stats`, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('통계 로드 실패');
                }
                
                const data = await response.json();
                
                document.getElementById('total-users').textContent = data.total_users;
                document.getElementById('total-sessions').textContent = data.total_sessions;
                document.getElementById('month-sessions').textContent = data.this_month_sessions;
                document.getElementById('pending-sessions').textContent = data.pending_sessions;
                
                document.getElementById('active-users-info').textContent = `활성 사용자: ${data.active_users}명`;
                document.getElementById('completion-rate').textContent = `완료율: ${data.completion_rate}%`;
                document.getElementById('month-completed').textContent = `완료: ${data.this_month_completed}건`;
                document.getElementById('expired-sessions-info').textContent = `만료: ${data.expired_sessions}건`;
                
            } catch (error) {
                console.error('통계 로드 오류:', error);
            }
        }
        
        // 월별 차트 로드
        async function loadMonthlyChart() {
            try {
                const response = await fetch(`${API_BASE}/admin/usage-stats?months=12`, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('월별 통계 로드 실패');
                }
                
                const data = await response.json();
                
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                
                if (monthlyChart) {
                    monthlyChart.destroy();
                }
                
                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.monthly_stats.map(stat => stat.month_name),
                        datasets: [{
                            label: '총 검사 수',
                            data: data.monthly_stats.map(stat => stat.total_sessions),
                            backgroundColor: 'rgba(66, 153, 225, 0.8)',
                            borderColor: 'rgba(66, 153, 225, 1)',
                            borderWidth: 1
                        }, {
                            label: '완료된 검사',
                            data: data.monthly_stats.map(stat => stat.completed_sessions),
                            backgroundColor: 'rgba(56, 161, 105, 0.8)',
                            borderColor: 'rgba(56, 161, 105, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '월별 검사 실행 현황'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('월별 차트 로드 오류:', error);
            }
        }
        
        // 사용자 목록 로드
        async function loadUsers(page = 1, search = '') {
            document.getElementById('users-loading').style.display = 'block';
            document.getElementById('users-table').style.display = 'none';
            document.getElementById('users-pagination').style.display = 'none';
            
            try {
                const url = new URL(`${API_BASE}/admin/users`);
                url.searchParams.append('page', page);
                url.searchParams.append('limit', 10);
                if (search) url.searchParams.append('search', search);
                
                const response = await fetch(url, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('사용자 목록 로드 실패');
                }
                
                const data = await response.json();
                
                currentUsersPage = data.pagination.current_page;
                totalUsersPages = data.pagination.total_pages;
                
                renderUserStatsSummary(data.users);
                renderUsersTable(data.users);
                renderUsersPagination();
                
                document.getElementById('users-loading').style.display = 'none';
                document.getElementById('users-table').style.display = 'table';
                document.getElementById('users-pagination').style.display = 'flex';
                
            } catch (error) {
                console.error('사용자 목록 로드 오류:', error);
                document.getElementById('users-loading').style.display = 'none';
            }
        }
        
        // 사용자 테이블 렌더링
        function renderUsersTable(users) {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';
            renderUserStatsSummary(users);
            // 월별 통계 카드 표시
            if (users.length === 1) {
                showUserMonthlyUsage(users[0].doctor_id, users[0].name);
            } else {
                document.getElementById('user-monthly-usage').innerHTML = '';
            }
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:8px 10px;">${user.name}</td>
                    <td style="padding:8px 10px;">${user.doctor_id}</td>
                    <td style="padding:8px 10px;">${user.email}</td>
                    <td style="padding:8px 10px;">${user.is_verified ? '인증' : '미인증'}</td>
                    <td style="padding:8px 10px;">${user.is_active ? '활성' : '비활성'}</td>
                    <td style="padding:8px 10px;"><button style="padding:6px 12px;border-radius:6px;background:#4299e1;color:#fff;border:none;cursor:pointer;" onclick="showUserMonthlyUsageCard('${user.doctor_id}','${user.name.replace(/'/g, '\'')}')">통계 보기</button></td>
                    <td style="padding:8px 10px; text-align:center;">
                        <label class="status-toggle">
                            <input type="checkbox" ${user.is_verified ? 'checked' : ''} onchange="toggleUserStatus('${user.doctor_id}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // 사용자 페이징 렌더링
        function renderUsersPagination() {
            const pageNumbers = document.getElementById('users-page-numbers');
            pageNumbers.innerHTML = '';
            
            document.getElementById('users-first-page').disabled = currentUsersPage === 1;
            document.getElementById('users-prev-page').disabled = currentUsersPage === 1;
            document.getElementById('users-next-page').disabled = currentUsersPage === totalUsersPages;
            document.getElementById('users-last-page').disabled = currentUsersPage === totalUsersPages;
            
            const maxVisible = 5;
            let start = Math.max(1, currentUsersPage - Math.floor(maxVisible / 2));
            let end = Math.min(totalUsersPages, start + maxVisible - 1);
            
            if (end - start + 1 < maxVisible) {
                start = Math.max(1, end - maxVisible + 1);
            }
            
            for (let i = start; i <= end; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => goToUsersPage(i);
                if (i === currentUsersPage) {
                    button.classList.add('active');
                }
                pageNumbers.appendChild(button);
            }
        }
        
        // 사용자 페이지 이동
        function goToUsersPage(page) {
            if (page < 1 || page > totalUsersPages) return;
            const search = document.getElementById('user-search').value;
            loadUsers(page, search);
        }
        
        // 사용자 검색
        function searchUsers() {
            let search = '';
            const searchInput = document.getElementById('user-search');
            if (searchInput) search = searchInput.value;
            loadUsers(1, search);
        }
        
        // 사용자 새로고침
        function refreshUsers() {
            let search = '';
            const searchInput = document.getElementById('user-search');
            if (searchInput) search = searchInput.value;
            loadUsers(currentUsersPage, search);
        }
        
        // 사용자 상태 토글
        async function toggleUserStatus(doctorId, isVerified) {
            try {
                const response = await fetch(`${API_BASE}/admin/users/${doctorId}/status`, {
                    method: 'PATCH',
                    headers: getApiHeaders(),
                    body: JSON.stringify({ is_verified: isVerified })
                });
                if (!response.ok) {
                    throw new Error('사용자 상태 변경 실패');
                }
                const result = await response.json();
                alert(result.message);
                // 목록 새로고침 (예외 처리)
                try {
                    refreshUsers();
                } catch (e) {
                    console.error('목록 새로고침 오류:', e);
                }
            } catch (error) {
                console.error('사용자 상태 변경 오류:', error);
                alert('상태 변경 중 오류가 발생했습니다.');
                // 체크박스 원래 상태로 복원
                try {
                    refreshUsers();
                } catch (e) {}
            }
        }
        
        // 사용자 통계 요약 렌더링
        function renderUserStatsSummary(users) {
            if (!users || users.length === 0) {
                document.getElementById('user-stats-summary').innerHTML = '';
                return;
            }
            // Top 3 검사수
            const topTotal = [...users].sort((a, b) => (b.total_sessions || 0) - (a.total_sessions || 0)).slice(0, 3);
            // Top 3 완료율 (완료율 0~100, 검사수 5건 이상만)
            const topCompletion = [...users]
                .filter(u => (u.total_sessions || 0) >= 5)
                .sort((a, b) => ((b.completed_sessions || 0) / (b.total_sessions || 1)) - ((a.completed_sessions || 0) / (a.total_sessions || 1)))
                .slice(0, 3);
            // Top 3 최근 30일 검사수
            const topRecent = [...users].sort((a, b) => (b.recent_30days_sessions || 0) - (a.recent_30days_sessions || 0)).slice(0, 3);
            
            function userCard(title, arr, valueFn, unit) {
                return `<div style="background:#f7fafc;border-radius:10px;padding:16px 18px;box-shadow:0 2px 8px rgba(0,0,0,0.04);min-width:220px;flex:1 1 220px;margin:0 8px 8px 0;">
                    <div style="font-weight:600;color:#2b6cb0;margin-bottom:8px;">${title}</div>
                    ${arr.map((u,i)=>`<div style='margin-bottom:4px;'><span style='font-weight:600;color:#222;'>${i+1}. ${u.name}</span> <span style='color:#888;font-size:0.95em;'>(${u.doctor_id})</span> <span style='color:#4299e1;font-weight:600;'>${valueFn(u)}${unit}</span></div>`).join('')}
                </div>`;
            }
            const html = `<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:18px;">
                ${userCard('검사수 Top 3', topTotal, u=>u.total_sessions||0, '건')}
                ${userCard('완료율 Top 3 (5건↑)', topCompletion, u=>u.total_sessions?Math.round((u.completed_sessions||0)/(u.total_sessions||1)*100):0, '%')}
                ${userCard('최근 30일 검사수 Top 3', topRecent, u=>u.recent_30days_sessions||0, '건')}
            </div>`;
            document.getElementById('user-stats-summary').innerHTML = html;
        }
        
        // 분석 데이터 로드
        async function loadAnalytics() {
            document.getElementById('analytics-loading').style.display = 'block';
            document.getElementById('analytics-content').style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/admin/usage-stats?months=6`, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('분석 데이터 로드 실패');
                }
                
                const data = await response.json();
                
                // 사용률 차트 생성
                const ctx = document.getElementById('usageChart').getContext('2d');
                
                if (usageChart) {
                    usageChart.destroy();
                }
                
                usageChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.monthly_stats.map(stat => stat.month_name),
                        datasets: [{
                            label: '활성 사용자',
                            data: data.monthly_stats.map(stat => stat.active_users),
                            borderColor: 'rgba(66, 153, 225, 1)',
                            backgroundColor: 'rgba(66, 153, 225, 0.1)',
                            tension: 0.4
                        }, {
                            label: '완료율 (%)',
                            data: data.monthly_stats.map(stat => stat.completion_rate),
                            borderColor: 'rgba(56, 161, 105, 1)',
                            backgroundColor: 'rgba(56, 161, 105, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '시스템 사용률 분석'
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                            }
                        }
                    }
                });
                
                // 요약 정보 생성
                const summaryHtml = `
                    <h3>📊 분석 요약</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #2d3748;">평균 완료율</div>
                            <div style="font-size: 1.5em; color: #4299e1;">${(data.monthly_stats.reduce((acc, stat) => acc + stat.completion_rate, 0) / data.monthly_stats.length).toFixed(1)}%</div>
                        </div>
                        <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #2d3748;">월평균 검사 수</div>
                            <div style="font-size: 1.5em; color: #38a169;">${Math.round(data.monthly_stats.reduce((acc, stat) => acc + stat.total_sessions, 0) / data.monthly_stats.length)}건</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('analytics-summary').innerHTML = summaryHtml;
                
                document.getElementById('analytics-loading').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';
                
            } catch (error) {
                console.error('분석 데이터 로드 오류:', error);
                document.getElementById('analytics-loading').style.display = 'none';
            }
        }
        
        // 로그 로드
        async function loadLogs(page = 1) {
            document.getElementById('logs-loading').style.display = 'block';
            
            try {
                const level = document.getElementById('log-level-filter').value;
                const url = new URL(`${API_BASE}/admin/system-logs`);
                url.searchParams.append('page', page);
                url.searchParams.append('limit', 20);
                if (level) url.searchParams.append('level', level);
                
                const response = await fetch(url, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('로그 로드 실패');
                }
                
                const data = await response.json();
                
                currentLogsPage = data.pagination.current_page;
                totalLogsPages = data.pagination.total_pages;
                
                renderLogs(data.logs);
                renderLogsPagination();
                
                document.getElementById('logs-loading').style.display = 'none';
                
            } catch (error) {
                console.error('로그 로드 오류:', error);
                document.getElementById('logs-loading').style.display = 'none';
            }
        }
        
        // 로그 렌더링
        function renderLogs(logs) {
            const container = document.getElementById('logs-container');
            container.innerHTML = '';
            
            if (logs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">로그가 없습니다.</p>';
                return;
            }
            
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const timestamp = log.timestamp ? 
                    new Date(log.timestamp).toLocaleString('ko-KR') : '-';
                
                logEntry.innerHTML = `
                    <div class="log-timestamp">${timestamp}</div>
                    <div class="log-message">${log.message}</div>
                    ${log.details ? `<div class="log-details">세부사항: ${JSON.stringify(log.details)}</div>` : ''}
                `;
                
                container.appendChild(logEntry);
            });
        }
        
        // 로그 페이징 렌더링
        function renderLogsPagination() {
            if (totalLogsPages <= 1) {
                document.getElementById('logs-pagination').style.display = 'none';
                return;
            }
            
            document.getElementById('logs-pagination').style.display = 'flex';
            
            const pageNumbers = document.getElementById('logs-page-numbers');
            pageNumbers.innerHTML = '';
            
            document.getElementById('logs-first-page').disabled = currentLogsPage === 1;
            document.getElementById('logs-prev-page').disabled = currentLogsPage === 1;
            document.getElementById('logs-next-page').disabled = currentLogsPage === totalLogsPages;
            document.getElementById('logs-last-page').disabled = currentLogsPage === totalLogsPages;
            
            const maxVisible = 5;
            let start = Math.max(1, currentLogsPage - Math.floor(maxVisible / 2));
            let end = Math.min(totalLogsPages, start + maxVisible - 1);
            
            for (let i = start; i <= end; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => goToLogsPage(i);
                if (i === currentLogsPage) {
                    button.classList.add('active');
                }
                pageNumbers.appendChild(button);
            }
        }
        
        // 로그 페이지 이동
        function goToLogsPage(page) {
            if (page < 1 || page > totalLogsPages) return;
            loadLogs(page);
        }
        
        // 로그 새로고침
        function refreshLogs() {
            loadLogs(1);
        }
        
        // 시스템 상태 확인
        async function checkSystemHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                const statusHtml = `
                    <p>✅ 데이터베이스: ${data.database.status === 'healthy' ? '정상' : '오류'}</p>
                    <p>✅ OpenAI API: ${data.openai === 'available' ? '정상' : '비활성'}</p>
                    <p>✅ 서버 시간: ${new Date(data.timestamp).toLocaleString('ko-KR')}</p>
                `;
                
                document.getElementById('system-status').innerHTML = statusHtml;
                
            } catch (error) {
                console.error('시스템 상태 확인 오류:', error);
                document.getElementById('system-status').innerHTML = '<p>❌ 시스템 상태 확인 실패</p>';
            }
        }
        
        // 정리 시뮬레이션
        async function simulateCleanup() {
            const days = document.getElementById('cleanup-days').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/cleanup?days_old=${days}&dry_run=true`, {
                    method: 'POST',
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('시뮬레이션 실패');
                }
                
                const data = await response.json();
                
                const resultHtml = `
                    <div style="background: #e6fffa; padding: 15px; border-radius: 8px; border-left: 4px solid #38b2ac;">
                        <h4>🧪 시뮬레이션 결과</h4>
                        <p><strong>정리 대상:</strong> ${days}일 이전 만료된 세션</p>
                        <p><strong>삭제될 세션 수:</strong> ${data.sessions_to_cleanup}개</p>
                        <p><strong>삭제될 총 데이터:</strong></p>
                        <ul>
                            <li>응답 데이터: ${data.cleanup_details.reduce((acc, item) => acc + (item.responses_to_delete || 0), 0)}개</li>
                            <li>해석 결과: ${data.cleanup_details.reduce((acc, item) => acc + (item.interpretations_to_delete || 0), 0)}개</li>
                        </ul>
                        <p style="margin-top: 10px;"><em>※ 이것은 시뮬레이션이며 실제 데이터는 삭제되지 않았습니다.</em></p>
                    </div>
                `;
                
                document.getElementById('cleanup-result').innerHTML = resultHtml;
                
                // 통계 새로고침
                loadDashboardStats();
                
            } catch (error) {
                console.error('정리 실행 오류:', error);
                document.getElementById('cleanup-result').innerHTML = 
                    '<div style="background: #fed7d7; padding: 15px; border-radius: 8px;">❌ 정리 실행 실패</div>';
            }
        }
        
        // 정리 실행
        async function executeCleanup() {
            const days = document.getElementById('cleanup-days').value;
            
            if (!confirm(`정말로 ${days}일 이전의 만료된 데이터를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/cleanup?days_old=${days}&dry_run=false`, {
                    method: 'POST',
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('정리 실행 실패');
                }
                
                const data = await response.json();
                
                const resultHtml = `
                    <div style="background: #c6f6d5; padding: 15px; border-radius: 8px; border-left: 4px solid #38a169;">
                        <h4>✅ 정리 완료</h4>
                        <p><strong>삭제된 세션 수:</strong> ${data.actual_cleaned}개</p>
                        <p><strong>정리 완료 시간:</strong> ${new Date().toLocaleString('ko-KR')}</p>
                    </div>
                `;
                
                document.getElementById('cleanup-result').innerHTML = resultHtml;
                
            } catch (error) {
                console.error('정리 실행 오류:', error);
                document.getElementById('cleanup-result').innerHTML = 
                    '<div style="background: #fed7d7; padding: 15px; border-radius: 8px;">❌ 정리 실행 실패</div>';
            }
        }
        
        // 월별 통계 카드 함수 추가
        async function showUserMonthlyUsage(doctorId, name) {
            try {
                console.log(`📡 API 요청: /admin/usage-stats?doctor_id=${doctorId}&months=12`);
                const response = await fetch(`${API_BASE}/admin/usage-stats?doctor_id=${doctorId}&months=12`, {
                    headers: getApiHeaders()
                });
                console.log('API 응답 상태:', response.status, response.statusText);
                if (!response.ok) throw new Error('월별 통계 로드 실패');
                const data = await response.json();

                // Debugging: log raw data (이제 필요 없으므로 제거)
                // console.log('📈 월별 통계 원본 데이터:', data.monthly_stats);

                // Ensure data points are numbers and find the maximum
                const allSessionValues = data.monthly_stats.flatMap(stat => [
                    Number(stat.total_sessions || 0),
                    Number(stat.completed_sessions || 0)
                ]);
                const maxDataValue = allSessionValues.length > 0 ? Math.max(...allSessionValues) : 0;
                
                // We will ensure y-axis always displays from 0 to 10 with step 1 for small values

                // 차트 컨테이너 생성
                const container = document.createElement('div');
                container.style.margin = '18px 0 24px 0';
                container.style.padding = '18px 20px';
                container.style.background = '#f7fafc';
                container.style.borderRadius = '10px';
                container.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)';
                container.style.height = '350px'; // 컨테이너에 고정 높이 추가
                container.style.overflow = 'hidden'; // 추가: 컨테이너의 내용을 벗어나지 않도록
                container.innerHTML = `<strong style="font-size: 1.1em;">👤 ${name} (${doctorId}) 월별 검사 통계</strong>`;
                
                // 캔버스 초기화 및 새로 생성 (강화된 초기화)
                let canvas = document.getElementById('user-monthly-chart-canvas');
                if (canvas) {
                    canvas.remove();
                }
                canvas = document.createElement('canvas');
                canvas.id = 'user-monthly-chart-canvas'; // 새로운 ID 부여
                canvas.style.marginTop = '15px';
                container.appendChild(canvas);

                document.getElementById('user-detail-stats').innerHTML = '';
                document.getElementById('user-detail-stats').appendChild(container);
                
                if (window.userMonthlyChart) {
                    window.userMonthlyChart.destroy();
                }

                // Y축 설정 값 로그 (디버깅)
                console.log('📊 Chart Y-axis Config:', { max: 10, stepSize: 1 });

                window.userMonthlyChart = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: data.monthly_stats.map(stat => stat.month_name),
                        datasets: [{
                            label: '총 검사 수',
                            data: data.monthly_stats.map(stat => Number(stat.total_sessions) || 0),
                            backgroundColor: 'rgba(66, 153, 225, 0.8)',
                            borderColor: 'rgba(66, 153, 225, 1)',
                            borderWidth: 1,
                            minBarLength: 20 // 최소 막대 길이 설정
                        }, {
                            label: '완료된 검사',
                            data: data.monthly_stats.map(stat => Number(stat.completed_sessions) || 0),
                            backgroundColor: 'rgba(56, 161, 105, 0.8)',
                            borderColor: 'rgba(56, 161, 105, 1)',
                            borderWidth: 1,
                            minBarLength: 20 // 최소 막대 길이 설정
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '월별 검사 현황'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.raw;
                                        return `${label}: ${value}건`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                min: 0, // Explicitly set min to 0
                                beginAtZero: true,
                                max: 10, // Explicitly set max to 10 for consistent small-value scaling
                                ticks: {
                                    stepSize: 1 // Explicitly set stepSize to 1
                                },
                                title: {
                                    display: true,
                                    text: '검사 수'
                                }
                            }
                        }
                    }
                });
                // 요약 정보 추가 (복구)
                const summary = document.createElement('div');
                summary.style.marginTop = '15px';
                summary.style.display = 'flex';
                summary.style.gap = '15px';
                summary.style.flexWrap = 'wrap';
                const totalSessions = data.monthly_stats.reduce((sum, stat) => sum + stat.total_sessions, 0);
                const totalCompleted = data.monthly_stats.reduce((sum, stat) => sum + stat.completed_sessions, 0);
                const avgCompletionRate = Math.round((totalCompleted / totalSessions * 100) || 0);
                summary.innerHTML = `
                    <div style="background: white; padding: 12px; border-radius: 8px; flex: 1; min-width: 150px;">
                        <div style="font-size: 0.9em; color: #666;">총 검사 수</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #4299e1;">${totalSessions}건</div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px; flex: 1; min-width: 150px;">
                        <div style="font-size: 0.9em; color: #666;">완료된 검사</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #38a169;">${totalCompleted}건</div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px; flex: 1; min-width: 150px;">
                        <div style="font-size: 0.9em; color: #666;">평균 완료율</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #805ad5;">${avgCompletionRate}%</div>
                    </div>
                `;
                container.appendChild(summary);
            } catch (e) {
                console.error('월별 통계 로드 오류:', e);
                document.getElementById('user-detail-stats').innerHTML = '<div style="color: #e53e3e; padding: 15px; background: #fff5f5; border-radius: 8px;">월별 통계 정보를 불러올 수 없습니다.</div>';
            }
        }

        async function loadAllUsersAndRenderTable() {
            try {
                const response = await fetch(`${API_BASE}/admin/users?limit=1000`, { headers: getApiHeaders() });
                if (!response.ok) throw new Error('이용자 목록 로드 실패');
                const data = await response.json();
                const users = data.users;
                const tbody = document.getElementById('user-table-body');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="padding:8px 10px;">${user.name}</td>
                        <td style="padding:8px 10px;">${user.doctor_id}</td>
                        <td style="padding:8px 10px;">${user.email}</td>
                        <td style="padding:8px 10px;">${user.is_verified ? '인증' : '미인증'}</td>
                        <td style="padding:8px 10px;">${user.is_active ? '활성' : '비활성'}</td>
                        <td style="padding:8px 10px;"><button style="padding:6px 12px;border-radius:6px;background:#4299e1;color:#fff;border:none;cursor:pointer;" onclick="showUserMonthlyUsageCard('${user.doctor_id}','${user.name.replace(/'/g, '\'')}')">통계 보기</button></td>
                        <td style="padding:8px 10px; text-align:center;">
                            <label class="status-toggle">
                                <input type="checkbox" ${user.is_verified ? 'checked' : ''} onchange="toggleUserStatus('${user.doctor_id}', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                document.getElementById('user-table-body').innerHTML = '<tr><td colspan="6" style="color:#e53e3e;">이용자 목록을 불러올 수 없습니다.</td></tr>';
            }
        }

        async function showUserMonthlyUsageCard(doctorId, name) {
            console.log(`✅ 통계 보기 버튼 클릭: ${name} (${doctorId})`);
            document.getElementById('user-detail-stats').innerHTML = '<div style="padding:20px;">불러오는 중...</div>';
            await showUserMonthlyUsage(doctorId, name);
        }

        // GPT 사용량 로드
        async function loadGPTUsage() {
            try {
                const startDate = document.getElementById('gpt-start-date').value;
                const endDate = document.getElementById('gpt-end-date').value;
                
                const response = await fetch(`${API_BASE}/admin/gpt-usage?start_date=${startDate}&end_date=${endDate}`, {
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('GPT 사용량 조회 실패');
                }
                
                const data = await response.json();
                
                // 총계 업데이트
                document.getElementById('total-tokens').textContent = data.total_usage.total_tokens.toLocaleString();
                document.getElementById('total-cost').textContent = `$${data.total_usage.total_cost.toFixed(2)}`;
                
                // 의사별 통계
                const doctorStats = document.getElementById('gpt-doctor-stats');
                doctorStats.innerHTML = data.doctor_stats.map(stat => `
                    <tr>
                        <td>${stat.doctor_id}</td>
                        <td>${stat.usage_count}</td>
                        <td>${stat.total_tokens.toLocaleString()}</td>
                        <td>$${stat.total_cost.toFixed(2)}</td>
                    </tr>
                `).join('');
                
                // 모델별 통계
                const modelStats = document.getElementById('gpt-model-stats');
                modelStats.innerHTML = data.model_stats.map(stat => `
                    <tr>
                        <td>${stat.model}</td>
                        <td>${stat.usage_count}</td>
                        <td>${stat.total_tokens.toLocaleString()}</td>
                        <td>$${stat.total_cost.toFixed(2)}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('GPT 사용량 조회 오류:', error);
                alert('GPT 사용량 조회 중 오류가 발생했습니다.');
            }
        }

        // 보안 모니터링 데이터 로드
        async function loadSecurityData() {
            try {
                // 로그인 시도 기록 로드
                const attemptsResponse = await fetch('/admin/login-attempts', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (attemptsResponse.ok) {
                    const attempts = await attemptsResponse.json();
                    const attemptsTable = document.getElementById('loginAttemptsTable');
                    attemptsTable.innerHTML = '';
                    
                    attempts.forEach(attempt => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(attempt.attempt_time).toLocaleString()}</td>
                            <td>${attempt.ip_address}</td>
                            <td>${attempt.doctor_id}</td>
                            <td>
                                <span class="badge ${attempt.success ? 'bg-success' : 'bg-danger'}">
                                    ${attempt.success ? '성공' : '실패'}
                                </span>
                            </td>
                            <td>${attempt.user_agent}</td>
                        `;
                        attemptsTable.appendChild(row);
                    });
                }
                
                // IP 차단 목록 로드
                const blocksResponse = await fetch('/admin/ip-blocks', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (blocksResponse.ok) {
                    const blocks = await blocksResponse.json();
                    const blocksTable = document.getElementById('ipBlocksTable');
                    blocksTable.innerHTML = '';
                    
                    blocks.forEach(block => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${block.ip_address}</td>
                            <td>${block.attempts}</td>
                            <td>${new Date(block.last_attempt).toLocaleString()}</td>
                            <td>${new Date(block.blocked_until).toLocaleString()}</td>
                        `;
                        blocksTable.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('보안 데이터 로드 중 오류:', error);
                showToast('보안 데이터를 불러오는 중 오류가 발생했습니다.', 'error');
            }
        }

        // 시스템 설정 로드
        async function loadSystemSettings() {
            try {
                const response = await fetch('/admin/settings', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const settings = await response.json();
                    document.getElementById('maxConcurrentSessions').value = settings.max_concurrent_sessions || 2;
                    document.getElementById('sessionTimeout').value = settings.session_timeout_minutes || 30;
                }
            } catch (error) {
                console.error('시스템 설정 로드 중 오류:', error);
                showToast('시스템 설정을 불러오는 중 오류가 발생했습니다.', 'error');
            }
        }

        // 시스템 설정 저장
        document.getElementById('systemSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const settings = {
                    max_concurrent_sessions: document.getElementById('maxConcurrentSessions').value,
                    session_timeout_minutes: document.getElementById('sessionTimeout').value
                };
                
                const response = await fetch('/admin/settings', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    showToast('시스템 설정이 저장되었습니다.', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.detail || '시스템 설정 저장 중 오류가 발생했습니다.', 'error');
                }
            } catch (error) {
                console.error('시스템 설정 저장 중 오류:', error);
                showToast('시스템 설정 저장 중 오류가 발생했습니다.', 'error');
            }
        });
    </script>
    <style>
    .status-toggle {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
    }
    .status-toggle input { display: none; }
    .status-toggle .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      border-radius: 22px;
      transition: .4s;
    }
    .status-toggle input:checked + .slider {
      background-color: #38a169;
    }
    .status-toggle .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: .4s;
    }
    .status-toggle input:checked + .slider:before {
      transform: translateX(18px);
    }
    </style>
</body>
</html>