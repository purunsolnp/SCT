<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCT 검사 관리 시스템</title>
    <style>
        /* 기존 스타일 유지 (필요한 부분만) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
        }
        .user-info {
            font-size: 0.9em;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        .form-input:focus {
            border-color: #4299e1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        .button {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.3);
        }
        .button-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: 2px solid #cbd5e0;
        }
        .button-secondary:hover {
            background: #cbd5e0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #718096;
            font-size: 0.9em;
            text-transform: uppercase;
            font-weight: 600;
        }
        .sessions-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            font-size: 1.05em;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border-radius: 10px;
            overflow: hidden;
        }
        .sessions-table th, .sessions-table td {
            padding: 16px 18px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .sessions-table th {
            background: #f1f5f9;
            font-weight: 700;
            color: #2b4360;
            font-size: 1.08em;
        }
        .sessions-table tr:hover {
            background: #f7fafc;
        }
        .sessions-table tr:last-child td {
            border-bottom: none;
        }
        .action-buttons {
            gap: 10px;
        }
        .action-button {
            padding: 7px 16px;
            border-radius: 6px;
            font-size: 0.97em;
            font-weight: 500;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            font-size: 1.5em;
            font-weight: 600;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        .action-button {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #4299e1;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        .action-button:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }
        .action-button .icon {
            font-size: 1.1em;
        }
        .modal-body {
            padding: 20px;
        }
        .interpretation-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 20px;
        }
        .response-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .response-item .item-number {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }
        .response-item .stem {
            color: #4a5568;
            margin-bottom: 10px;
        }
        .response-item .answer {
            color: #2d3748;
            font-weight: 500;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .close-button {
            background: none;
            border: none;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            color: #667eea;
        }
        .responses-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 20px;
        }
        .responses-content .response-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .responses-content .response-item .item-number {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }
        .responses-content .response-item .stem {
            color: #4a5568;
            margin-bottom: 10px;
        }
        .responses-content .response-item .answer {
            color: #2d3748;
            font-weight: 500;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        @media print {
            body, html {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            /* 모든 UI 숨김 */
            .header, .container, .modal-header, .modal-actions, .close-button, .action-button, .modal, .modal-content, .modal-body, .modal-footer, .stats-grid, .card, .search-controls, .pagination, .sessions-table, .stat-card, .stat-number, .stat-label, .form-group, .form-input, .form-select, .button, .button-secondary, .alert, .link-display, .link-text, .logout-btn, .user-info, .debug-info, .debug-content, .footer, .no-print, .print-hide {
                display: none !important;
            }
            /* 보고서 본문만 인쇄 */
            #interpretation-modal, .interpretation-content {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                color: #222 !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                font-size: 1.1em !important;
            }
            /* 인쇄 시 페이지 넘버, 머리글/푸터 숨김 */
            @page {
                size: A4;
                margin: 2cm;
            }
            /* 인쇄 시 스크롤바 숨김 */
            ::-webkit-scrollbar { display: none !important; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>🏥 SCT 검사 관리 시스템</h1>
            <div class="user-info">
                <div>
                    <strong>의사:</strong> <span id="doctor-name">로딩중...</span><br>
                    <small>ID: <span id="doctor-id">로딩중...</span></small>
                </div>
                <button onclick="logout()" class="logout-btn">🚪 로그아웃</button>
            </div>
        </div>
    </div>
    <div class="container">
        <!-- 통계 카드 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-sessions">0</div>
                <div class="stat-label">총 세션</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completed-sessions">0</div>
                <div class="stat-label">완료된 검사</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pending-sessions">0</div>
                <div class="stat-label">대기 중</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expired-sessions">0</div>
                <div class="stat-label">만료됨</div>
            </div>
        </div>
        <!-- 새 검사 생성 -->
        <div class="card">
            <h2>🆕 새 SCT 검사 생성</h2>
            <form id="create-session-form">
                <div class="form-group">
                    <label for="patient-name">환자 이름</label>
                    <input type="text" id="patient-name" class="form-input" placeholder="환자 이름을 입력하세요" required>
                </div>
                <button type="submit" class="button">검사 세션 생성</button>
            </form>
            <div id="new-session-alert" class="alert alert-success" style="display: none;">
                <strong>✅ 새 검사가 생성되었습니다!</strong>
                <div class="link-display">
                    <p><strong>환자에게 전달할 검사 링크:</strong></p>
                    <div class="link-text" id="patient-link"></div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="copyLink()" class="button button-secondary">📋 링크 복사</button>
                        <button onclick="sendKakaoLink()" class="button">💬 카카오톡 전송</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 검사 목록 -->
        <div class="card">
            <h2>📋 검사 세션 목록</h2>
            
            <!-- 검색 및 필터 컨트롤 -->
            <div class="search-controls">
                <input type="text" class="search-input" id="search-patient" placeholder="🔍 환자 이름으로 검색...">
                <select class="filter-select" id="status-filter">
                    <option value="">전체 상태</option>
                    <option value="complete">완료</option>
                    <option value="incomplete">대기중</option>
                    <option value="expired">만료</option>
                </select>
                <input type="date" class="search-input" id="date-from" title="시작일">
                <input type="date" class="search-input" id="date-to" title="종료일">
                <button onclick="resetFilters()" class="button button-secondary">🔄 초기화</button>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button onclick="refreshSessions()" class="button button-secondary">🔄 새로고침</button>
                <div class="pagination-info" id="pagination-info">0개 결과</div>
            </div>
            
            <div id="sessions-loading" class="loading" style="display: none;">
                검사 목록을 불러오는 중...
            </div>
            
            <table class="sessions-table" id="sessions-table" style="display: none;">
                <thead>
                    <tr>
                        <th>환자명</th>
                        <th>생성일</th>
                        <th>제출일</th>
                        <th>만료일</th>
                        <th>상태</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="sessions-tbody">
                </tbody>
            </table>
            
            <!-- 페이징 -->
            <div class="pagination" id="pagination" style="display: none;">
                <button onclick="goToPage(1)" id="first-page"><<</button>
                <button onclick="goToPage(currentPage - 1)" id="prev-page"><</button>
                <div id="page-numbers"></div>
                <button onclick="goToPage(currentPage + 1)" id="next-page">></button>
                <button onclick="goToPage(totalPages)" id="last-page">>></button>
            </div>
            
            <div id="no-sessions" style="display: none; text-align: center; color: #718096; padding: 40px;">
                검색 조건에 맞는 검사 세션이 없습니다.
            </div>
        </div>
    </div>
    
    <!-- 해석 결과 모달 -->
    <div id="interpretation-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SCT 해석 결과</h2>
                <div class="modal-actions">
                    <button onclick="printInterpretation()" class="action-button">
                        <span class="icon">🖨️</span> PDF로 저장/인쇄
                    </button>
                    <button onclick="regenerateInterpretation()" class="action-button">
                        <span class="icon">🔄</span> 재생성
                    </button>
                    <button onclick="showOriginalResponses()" class="action-button">
                        <span class="icon">📝</span> 원본 응답
                    </button>
                    <button onclick="closeModal('interpretation-modal')" class="close-button">×</button>
                </div>
            </div>
            <div class="modal-body">
                <div id="interpretation-content" class="interpretation-content"></div>
            </div>
        </div>
    </div>

    <!-- 원본 응답 모달 -->
    <div id="responses-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>원본 응답</h2>
                <button onclick="closeModal('responses-modal')" class="close-button">×</button>
            </div>
            <div class="modal-body">
                <div id="responses-content" class="responses-content"></div>
            </div>
        </div>
    </div>

    <script>
        // === API 서버 주소를 여기에 설정하세요 ===
        const API_BASE = "https://sct-backend-7epf.onrender.com";
        // ======================================
        let doctorId = '';
        let doctorName = '';
        let allSessions = []; // 전체 세션 데이터
        let filteredSessions = []; // 필터링된 세션 데이터
        let currentSessionLink = '';
        let currentSessionId = '';
        let currentInterpretation = '';
        let debugMode = false;
        
        // 페이징 관련 변수
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalPages = 1;
        
        // 디버그 함수
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage, data || '');
            
            if (debugMode) {
                const debugContent = document.getElementById('debug-content');
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `${logMessage}${data ? ': ' + JSON.stringify(data, null, 2) : ''}`;
                debugContent.appendChild(logEntry);
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = debugMode ? 'block' : 'none';
            
            if (debugMode) {
                document.getElementById('debug-content').innerHTML = '';
                debugLog('디버그 모드 활성화');
                debugLog('현재 API_BASE', API_BASE);
                debugLog('현재 doctorId', doctorId);
                debugLog('현재 sessions 수', allSessions.length);
            }
        }
        
        // API 헤더 (JWT 토큰 포함)
        function getApiHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }
        
        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('페이지 로드 시작');
            
            // 로그인 확인
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                alert('로그인이 필요합니다.');
                window.location.href = 'login.html';
                return;
            }
            
            // 사용자 정보 설정
            const userData = JSON.parse(currentUser);
            doctorId = userData.doctorId;
            doctorName = userData.name;
            
            debugLog('사용자 정보 로드', { doctorId, doctorName });
            
            document.getElementById('doctor-id').textContent = doctorId;
            document.getElementById('doctor-name').textContent = doctorName;
            
            loadSessions();
            setupEventListeners();
        });
        
        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 폼 제출 이벤트
            document.getElementById('create-session-form').addEventListener('submit', createSession);
            
            // 검색 및 필터 이벤트
            document.getElementById('search-patient').addEventListener('input', applyFilters);
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('date-from').addEventListener('change', applyFilters);
            document.getElementById('date-to').addEventListener('change', applyFilters);
        }
        
        // 로그아웃
        function logout() {
            if (confirm('정말 로그아웃 하시겠습니까?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('access_token');
                window.location.href = 'login.html';
            }
        }
        
        // 새 세션 생성
        async function createSession(event) {
            event.preventDefault();
            
            const patientName = document.getElementById('patient-name').value.trim();
            if (!patientName) {
                alert('환자 이름을 입력해주세요.');
                return;
            }
            
            debugLog('새 세션 생성 시작', { patientName, doctorId });
            
            try {
                const requestBody = {
                    patient_name: patientName,
                    assigned_by: doctorId
                };
                
                debugLog('전송할 데이터', requestBody);
                
                const response = await fetch(`${API_BASE}/sct/sessions`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify(requestBody)
                });
                
                debugLog('세션 생성 응답 상태', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('로그인이 만료되었습니다. 다시 로그인해주세요.');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }
                    const errorData = await response.json();
                    debugLog('세션 생성 오류', errorData);
                    throw new Error(errorData.detail || '세션 생성에 실패했습니다.');
                }
                
                const sessionData = await response.json();
                debugLog('생성된 세션', sessionData);
                
                // 성공 메시지 및 링크 표시
                const patientLink = `${window.location.origin}/patient.html?session=${sessionData.session_id}`;
                currentSessionLink = patientLink;

                // 링크 텍스트 설정
                const linkElement = document.getElementById('patient-link');
                if (linkElement) {
                    linkElement.textContent = patientLink;
                }

                // 알림 표시
                const alertElement = document.getElementById('new-session-alert');
                if (alertElement) {
                    alertElement.style.display = 'block';
                }

                // 링크 표시 영역도 표시
                const linkDisplayElement = document.querySelector('.link-display');
                if (linkDisplayElement) {
                    linkDisplayElement.style.display = 'block';
                }
                
                // 폼 초기화
                document.getElementById('patient-name').value = '';
                
                // 세션 목록 새로고침
                await loadSessions();
                
            } catch (error) {
                debugLog('세션 생성 오류', error.message);
                alert('세션 생성 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 세션 목록 로드
        async function loadSessions() {
            debugLog('세션 목록 로드 시작');
            document.getElementById('sessions-loading').style.display = 'block';
            document.getElementById('sessions-table').style.display = 'none';
            document.getElementById('no-sessions').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
            
            try {
                const url = `${API_BASE}/sct/sessions/by-user/${doctorId}`;
                debugLog('API 요청 URL', url);
                
                const response = await fetch(url, {
                    headers: getApiHeaders()
                });
                
                debugLog('API 응답 상태', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('로그인이 만료되었습니다. 다시 로그인해주세요.');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }
                    const errorText = await response.text();
                    debugLog('API 응답 오류', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                debugLog('받은 데이터', data);
                
                // 데이터 구조 확인 및 정규화
                allSessions = Array.isArray(data) ? data : (data.sessions || []);
                debugLog('처리된 세션 데이터', allSessions);
                
                // 초기 필터링 및 렌더링
                applyFilters();
                updateStats();
                
            } catch (error) {
                debugLog('세션 로드 오류', error.message);
                alert('세션 목록 로드 중 오류가 발생했습니다: ' + error.message);
                
                // 오류 발생 시 빈 배열로 초기화
                allSessions = [];
                filteredSessions = [];
                updateStats();
                renderSessionsTable();
            } finally {
                document.getElementById('sessions-loading').style.display = 'none';
            }
        }
        
        // 필터 적용
        function applyFilters() {
            const searchTerm = document.getElementById('search-patient').value.toLowerCase().trim();
            const statusFilter = document.getElementById('status-filter').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            
            debugLog('필터 적용', { searchTerm, statusFilter, dateFrom, dateTo });
            
            filteredSessions = allSessions.filter(session => {
                // 환자명 검색
                if (searchTerm) {
                    const patientName = (session.patient_name || session.patientName || '').toLowerCase();
                    if (!patientName.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // 상태 필터
                if (statusFilter && session.status !== statusFilter) {
                    return false;
                }
                
                // 날짜 범위 필터
                if (dateFrom || dateTo) {
                    const sessionDate = new Date(session.created_at || session.createdAt);
                    
                    if (dateFrom) {
                        const fromDate = new Date(dateFrom);
                        if (sessionDate < fromDate) {
                            return false;
                        }
                    }
                    
                    if (dateTo) {
                        const toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59, 999); // 하루 끝까지
                        if (sessionDate > toDate) {
                            return false;
                        }
                    }
                }
                
                return true;
            });
            
            debugLog('필터링 결과', `${filteredSessions.length}/${allSessions.length}`);
            
            // 페이징 초기화
            currentPage = 1;
            calculatePagination();
            renderSessionsTable();
            renderPagination();
        }
        
        // 필터 초기화
        function resetFilters() {
            document.getElementById('search-patient').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            applyFilters();
        }
        
        // 페이징 계산
        function calculatePagination() {
            totalPages = Math.ceil(filteredSessions.length / itemsPerPage);
            if (totalPages === 0) totalPages = 1;
            if (currentPage > totalPages) currentPage = totalPages;
        }
        
        // 페이지 이동
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderSessionsTable();
            renderPagination();
        }
        
        // 페이징 UI 렌더링
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const pageNumbers = document.getElementById('page-numbers');
            const paginationInfo = document.getElementById('pagination-info');
            
            if (filteredSessions.length === 0) {
                pagination.style.display = 'none';
                paginationInfo.textContent = '0개 결과';
                return;
            }
            
            pagination.style.display = 'flex';
            
            // 페이지 정보
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, filteredSessions.length);
            paginationInfo.textContent = `${startItem}-${endItem} / 총 ${filteredSessions.length}개`;
            
            // 이전/다음 버튼 상태
            document.getElementById('first-page').disabled = currentPage === 1;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            document.getElementById('last-page').disabled = currentPage === totalPages;
            
            // 페이지 번호 버튼
            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => goToPage(i);
                if (i === currentPage) {
                    button.classList.add('active');
                }
                pageNumbers.appendChild(button);
            }
        }
        
        // 통계 업데이트
        function updateStats() {
            debugLog('통계 업데이트', allSessions);
            
            const total = allSessions ? allSessions.length : 0;
            const completed = allSessions ? allSessions.filter(s => s.status === 'complete').length : 0;
            const pending = allSessions ? allSessions.filter(s => s.status === 'incomplete').length : 0;
            const expired = allSessions ? allSessions.filter(s => s.status === 'expired').length : 0;
            
            debugLog('통계 결과', { total, completed, pending, expired });
            
            document.getElementById('total-sessions').textContent = total;
            document.getElementById('completed-sessions').textContent = completed;
            document.getElementById('pending-sessions').textContent = pending;
            document.getElementById('expired-sessions').textContent = expired;
        }
        
        // 세션 테이블 렌더링
        function renderSessionsTable() {
            debugLog('테이블 렌더링 시작', `필터링된 세션 수: ${filteredSessions.length}`);
            const tbody = document.getElementById('sessions-tbody');
            tbody.innerHTML = '';
            
            if (!filteredSessions || filteredSessions.length === 0) {
                document.getElementById('no-sessions').style.display = 'block';
                document.getElementById('sessions-table').style.display = 'none';
                debugLog('필터링된 세션이 없음');
                return;
            }
            
            document.getElementById('sessions-table').style.display = 'table';
            document.getElementById('no-sessions').style.display = 'none';
            
            // 페이징 적용
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPageSessions = filteredSessions.slice(startIndex, endIndex);
            
            currentPageSessions.forEach((session, index) => {
                debugLog(`세션 ${startIndex + index + 1} 처리`, session);
                
                const row = document.createElement('tr');
                
                // 안전한 데이터 추출
                let patientName = 'UNKNOWN';
                
                if (session.patient_name && session.patient_name.trim() !== '') {
                    patientName = session.patient_name.trim();
                } else if (session.patientName && session.patientName.trim() !== '') {
                    patientName = session.patientName.trim();
                } else {
                    console.warn('❌ 환자 이름을 찾을 수 없음, 세션 전체:', session);
                    patientName = 'NO_NAME_FOUND';
                }
                
                const sessionId = session.session_id || session.sessionId || 'Unknown';
                const status = session.status || 'unknown';
                
                // 날짜 포맷팅 (KST 기준)
                const createdAt = formatDate(session.created_at || session.createdAt);
                const submittedAt = formatDate(session.submitted_at || session.submittedAt);
                const expiresAt = formatDate(session.expires_at || session.expiresAt);
                
                // 상태 뱃지
                const { statusClass, statusText } = getStatusInfo(status);
                
                // 작업 버튼들
                const actionButtons = generateActionButtons(session, sessionId);
                
                row.innerHTML = `
                    <td>${patientName}</td>
                    <td>${createdAt}</td>
                    <td>${submittedAt}</td>
                    <td>${expiresAt}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            debugLog('테이블 렌더링 완료');
        }
        
        // 안전한 날짜 포맷팅 함수 (KST 기준)
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Invalid Date';
                return date.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'Asia/Seoul'
                });
            } catch {
                return 'Format Error';
            }
        }
        
        // 상태 정보 반환
        function getStatusInfo(status) {
            let statusClass = '';
            let statusText = '';
            
            switch (status) {
                case 'incomplete':
                    statusClass = 'status-incomplete';
                    statusText = '대기중';
                    break;
                case 'complete':
                    statusClass = 'status-complete';
                    statusText = '완료';
                    break;
                case 'expired':
                    statusClass = 'status-expired';
                    statusText = '만료';
                    break;
                default:
                    statusClass = 'status-incomplete';
                    statusText = '알 수 없음';
            }
            
            return { statusClass, statusText };
        }
        
        // 작업 버튼 생성
        function generateActionButtons(session, sessionId) {
            const status = session.status || 'incomplete';
            let actionButtons = '';
            
            if (status === 'incomplete') {
                const patientLink = `${window.location.origin}/patient.html?session=${sessionId}`;
                actionButtons = `
                    <button onclick="copySessionLink('${patientLink}')" class="action-button copy">링크 복사</button>
                    <button onclick="deleteSession('${sessionId}')" class="action-button delete">삭제</button>
                `;
            } else if (status === 'complete') {
                actionButtons = `
                    <button onclick="openAnalysisModal('${sessionId}')" class="action-button interpret">📊 전문 해석</button>
                    <button onclick="deleteSession('${sessionId}')" class="action-button delete">삭제</button>
                `;
            } else {
                actionButtons = `
                    <button onclick="deleteSession('${sessionId}')" class="action-button delete">삭제</button>
                `;
            }
            
            return actionButtons;
        }
        
        // 세션 삭제
        async function deleteSession(sessionId) {
            const session = allSessions.find(s => s.session_id === sessionId);
            const patientName = session ? (session.patient_name || session.patientName || 'Unknown') : 'Unknown';
            
            if (!confirm(`정말로 "${patientName}"의 검사 세션을 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
                return;
            }
            
            try {
                debugLog('세션 삭제 시도', sessionId);
                
                const response = await fetch(`${API_BASE}/sct/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('로그인이 만료되었습니다. 다시 로그인해주세요.');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error('세션 삭제에 실패했습니다.');
                }
                
                alert('세션이 성공적으로 삭제되었습니다.');
                
                // 세션 목록 새로고침
                await loadSessions();
                
            } catch (error) {
                debugLog('세션 삭제 오류', error.message);
                alert('세션 삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 링크 복사
        function copyLink() {
            navigator.clipboard.writeText(currentSessionLink).then(() => {
                alert('링크가 클립보드에 복사되었습니다!');
            });
        }
        
        // 세션 링크 복사
        function copySessionLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('검사 링크가 클립보드에 복사되었습니다!');
            });
        }
        
        // 카카오톡 전송
        function sendKakaoLink() {
            alert('카카오톡 전송 기능은 추후 구현 예정입니다.\n현재는 링크를 복사해서 직접 전송해주세요.');
        }
        
        // 세션 목록 새로고침
        function refreshSessions() {
            debugLog('세션 목록 새로고침 요청');
            loadSessions();
        }
        
        // 분석 모달 열기 (팝업 대신 모달 사용)
        async function openAnalysisModal(sessionId) {
            debugLog('분석 모달 열기', sessionId);
            currentSessionId = sessionId;

            // 모달 열기
            document.getElementById('interpretation-modal').style.display = 'block';
            document.getElementById('interpretation-content').innerHTML = '로딩중...';

            try {
                let interpretationResponse = await fetch(`${API_BASE}/sct/sessions/${sessionId}/interpretation`, {
                    headers: getApiHeaders()
                });
                if (interpretationResponse.status === 404) {
                    // 해석이 없으면 새로 생성
                    await fetch(`${API_BASE}/sct/sessions/${sessionId}/interpret`, {
                        method: 'POST',
                        headers: getApiHeaders()
                    });
                    interpretationResponse = await fetch(`${API_BASE}/sct/sessions/${sessionId}/interpretation`, {
                        headers: getApiHeaders()
                    });
                }
                if (!interpretationResponse.ok) {
                    throw new Error('해석 결과를 불러올 수 없습니다.');
                }
                const data = await interpretationResponse.json();
                currentInterpretation = data.interpretation;
                document.getElementById('interpretation-content').innerHTML = 
                    marked.parse(data.interpretation);
            } catch (error) {
                document.getElementById('interpretation-content').innerHTML = `<div style="color:red;">❌ 오류: ${error.message}</div>`;
            }
        }
        
        // 해석 재생성 함수
        async function regenerateInterpretation() {
            const sessionId = currentSessionId;
            if (!sessionId) return;

            try {
                showLoading('해석을 재생성하는 중입니다...');
                
                const response = await fetch(`${API_BASE}/sct/sessions/${sessionId}/regenerate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('해석 재생성에 실패했습니다.');
                }

                const data = await response.json();
                
                // 해석 내용 업데이트
                document.getElementById('interpretation-content').innerHTML = 
                    marked.parse(data.interpretation);
                
                showSuccess('해석이 재생성되었습니다.');
                
            } catch (error) {
                console.error('해석 재생성 오류:', error);
                showError('해석 재생성 중 오류가 발생했습니다.');
            } finally {
                hideLoading();
            }
        }

        // 원본 응답 보기 함수
        async function showOriginalResponses() {
            const sessionId = currentSessionId;
            if (!sessionId) return;

            try {
                showLoading('응답을 불러오는 중입니다...');
                
                const response = await fetch(`${API_BASE}/sct/sessions/${sessionId}/responses`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('응답 조회에 실패했습니다.');
                }

                const data = await response.json();
                
                // 응답 내용 구성
                const responsesHtml = data.responses.map(r => `
                    <div class="response-item">
                        <div class="item-number">문항 ${r.item_no}</div>
                        <div class="stem">${r.stem}</div>
                        <div class="answer">${r.answer}</div>
                    </div>
                `).join('');
                
                document.getElementById('responses-content').innerHTML = responsesHtml;
                
                // 원본 응답 모달 표시
                document.getElementById('interpretation-modal').style.display = 'none';
                document.getElementById('responses-modal').style.display = 'block';
                
            } catch (error) {
                console.error('응답 조회 오류:', error);
                showError('응답 조회 중 오류가 발생했습니다.');
            } finally {
                hideLoading();
            }
        }

        // 모달 닫기 함수 수정
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'responses-modal') {
                document.getElementById('interpretation-modal').style.display = 'block';
            }
        }

        function printInterpretation() {
            window.print();
        }

        function showLoading(message = '처리 중입니다...') {
            if (document.getElementById('global-loading')) return;
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'global-loading';
            loadingDiv.style.position = 'fixed';
            loadingDiv.style.top = '0';
            loadingDiv.style.left = '0';
            loadingDiv.style.width = '100vw';
            loadingDiv.style.height = '100vh';
            loadingDiv.style.background = 'rgba(0,0,0,0.25)';
            loadingDiv.style.zIndex = '9999';
            loadingDiv.style.display = 'flex';
            loadingDiv.style.flexDirection = 'column';
            loadingDiv.style.justifyContent = 'center';
            loadingDiv.style.alignItems = 'center';
            loadingDiv.innerHTML = `
                <div style="background:white;padding:30px 40px;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,0.12);font-size:1.2em;display:flex;flex-direction:column;align-items:center;">
                    <div class="spinner" style="margin-bottom:18px;">
                        <svg width="40" height="40" viewBox="0 0 40 40">
                            <circle cx="20" cy="20" r="16" stroke="#4299e1" stroke-width="4" fill="none" stroke-dasharray="80" stroke-dashoffset="60">
                                <animateTransform attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="1s" repeatCount="indefinite"/>
                            </circle>
                        </svg>
                    </div>
                    <div>${message}</div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('global-loading');
            if (loadingDiv) loadingDiv.remove();
        }
    </script>
</body>
</html>